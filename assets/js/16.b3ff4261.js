(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{373:function(t,s,a){"use strict";a.r(s);var n=a(12),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("I recently built a social aggregator called Full Social ("),a("a",{attrs:{href:"https://full.social",title:"Full Social",target:"_blank",rel:"noopener noreferrer"}},[t._v("full.social"),a("OutboundLink")],1),t._v(") built on Ruby on Rails.  The idea is to associate a person's social network accounts to a single user.  I found that the best way to accomplish this is to create a 1:M association between a user model and an identity model.  The idenetity model is where various OAuth tokens are stored and associate them with a single user.")]),t._v(" "),a("h3",{attrs:{id:"configuring-omniauth"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configuring-omniauth"}},[t._v("#")]),t._v(" Configuring Omniauth")]),t._v(" "),a("p",[t._v("I decided to use the "),a("a",{attrs:{href:"https://github.com/intridea/omniauth",title:"Omniauth",target:"_blank",rel:"noopener noreferrer"}},[t._v("omniauth gem"),a("OutboundLink")],1),t._v(" to handle the OAuth token request process.  On top of the omniauth gem, be sure to also include the appropriate gems for each api (i.e. omniauth-twitter).Here's an example of a configuration file that could be used.")]),t._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# config/initializers/omniauth.rb")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Rails")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("application"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("middleware"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("use "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("OmniAuth")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Builder")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v("\n  provider "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":facebook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"FACEBOOK_APP_ID"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"FACEBOOK_SECRET"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" scope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"email,public_profile,user_likes"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  provider "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":twitter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"TWITTER_KEY"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"TWITTER_SECRET"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  provider "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":instagram")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INSTAGRAM_KEY"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INSTAGRAM_SECRET"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),a("h3",{attrs:{id:"handling-the-callback"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#handling-the-callback"}},[t._v("#")]),t._v(" Handling the Callback")]),t._v(" "),a("p",[t._v("You'll need to add a route to your "),a("code",[t._v("config/routes.rb")]),t._v(" file to handle the callback that is made after a user approves your app for use.")]),t._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# config/routes.rb")]),t._v("\nget "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/auth/:provider/callback'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sessions#create'")]),t._v("\n")])])]),a("p",[t._v("In my particular case, I'm also using the user's social networks to act as a log in.  We will create a sessions controller to handle this.")]),t._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# app/controllers/sessions_controller.rb")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SessionsController")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ApplicationController")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" auth_hash\n      identity "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Identity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("where"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("provider"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("provider"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" uid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("uid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("first\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" identity\n        user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("find_by"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" identity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        identity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update_attributes"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          expires_at"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" expires_at\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n        user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" logged_in"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" current_user "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" email"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("email"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Identity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          provider"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("provider"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          uid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("uid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          expires_at"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" expires_at"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          user_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n      session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":user_id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unless")]),t._v(" logged_in"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n    redirect_to root_path\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("auth_hash")])]),t._v("\n    request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"omniauth.auth"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("expires_at")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expires_at"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("present"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("at"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expires_at"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("to_datetime\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("elsif")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expires_in"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("present"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("DateTime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("now "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" auth_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expires_in"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("to_i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("seconds\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),a("p",[t._v("It could use a bit of refactoring, but it gets the job done.  If a user has never been to the site before, then they pick a provider to log in with, a user is created, and an identity is created for that particular provider and associates the Identity to that user.  Once the user is logged in, they can now connect other social accounts and new identities are created and associated to the current user.  That user can now log back in once their session is expired with any identities that have authorized the application.")])])}),[],!1,null,null,null);s.default=e.exports}}]);